trigger:
  branches:
    include:
      - main

variables:
- group: azure_credential
- name: TF_VERSION
  value: '1.6.6'
- name: RESOURCE_GROUP_NAME
  value: 'my-vnet-rg'
- name: VNET_NAME
  value: 'my-vnet'
- name: LOCATION
  value: 'eastus'

pool:
  vmImage: 'ubuntu-latest'
  timeoutInMinutes: 60  # Increased timeout to avoid job cancellations

stages:
- stage: Validate
  jobs:
  - job: TerraformValidation
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: '$(TF_VERSION)'

    - task: AzureCLI@2
      inputs:
        azureSubscription: 'azure-sc'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        workingDirectory: '$(Build.SourcesDirectory)/Project_2/terraform'
        inlineScript: |
          set -exo pipefail
          echo "Exporting credentials..."
          export ARM_CLIENT_ID=$(CLIENT_ID)
          export ARM_CLIENT_SECRET=$(CLIENT_SECRET)
          export ARM_SUBSCRIPTION_ID=$(SUBSCRIPTION_ID)
          export ARM_TENANT_ID=$(TENANT_ID)

          echo "Initializing Terraform..."
          terraform init -no-color -input=false

          echo "Validating Terraform..."
          terraform validate -no-color

          echo "Planning Terraform deployment..."
          terraform plan -no-color -input=false \
            -var="resource_group_name=$(RESOURCE_GROUP_NAME)" \
            -var="vnet_name=$(VNET_NAME)" \
            -var="location=$(LOCATION)"

- stage: Deploy
  dependsOn: Validate
  condition: succeeded()
  jobs:
  - job: TerraformApply
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: '$(TF_VERSION)'

    - task: AzureCLI@2
      inputs:
        azureSubscription: 'azure-sc'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        workingDirectory: '$(Build.SourcesDirectory)/Project_2/terraform'
        inlineScript: |
          set -exo pipefail
          echo "Exporting credentials..."
          export ARM_CLIENT_ID=$(CLIENT_ID)
          export ARM_CLIENT_SECRET=$(CLIENT_SECRET)
          export ARM_SUBSCRIPTION_ID=$(SUBSCRIPTION_ID)
          export ARM_TENANT_ID=$(TENANT_ID)

          echo "Applying Terraform changes..."
          terraform apply -auto-approve -no-color -input=false \
            -var="resource_group_name=$(RESOURCE_GROUP_NAME)" \
            -var="vnet_name=$(VNET_NAME)" \
            -var="location=$(LOCATION)"

    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: |
          echo "Saving Terraform outputs to JSON..."
          terraform output -json > $(Build.ArtifactStagingDirectory)/outputs.json

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/outputs.json'
        artifact: 'terraform-outputs'


         

























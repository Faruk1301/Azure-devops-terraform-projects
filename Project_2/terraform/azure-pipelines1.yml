trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: azure_credential  # This includes the variable group (if you have any other variables)
  
  terraformWorkingDirectory: 'Project_2/terraform'  # Ensure this matches your repo

stages:
  - stage: Terraform_Deploy
    displayName: 'Terraform Deployment'
    jobs:
      - job: Terraform
        displayName: 'Run Terraform'
        steps:
          - checkout: self
          
          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: 'latest'

          - task: Bash@2
            displayName: 'Azure CLI Authentication'
            inputs:
              targetType: 'inline'
              script: |
                echo "Logging in to Azure using service principal"
                az login --service-principal -u $(CLIENT_ID) -p $(CLIENT_SECRET) --tenant $(TENANT_ID)
                az account set --subscription $(SUBSCRIPTION_ID)
          
          - task: Bash@3
            displayName: 'Terraform Init'
            inputs:
              targetType: 'inline'
              script: |
                terraform init
              workingDirectory: $(terraformWorkingDirectory)

          - task: Bash@3
            displayName: 'Terraform Plan'
            inputs:
              targetType: 'inline'
              script: |
                terraform plan -out=tfplan
              workingDirectory: $(terraformWorkingDirectory)

          - task: Bash@3
            displayName: 'Terraform Apply'
            inputs:
              targetType: 'inline'
              script: |
                terraform apply -auto-approve tfplan
              workingDirectory: $(terraformWorkingDirectory)

          - task: Bash@3
            displayName: 'Terraform Output'
            inputs:
              targetType: 'inline'
              script: |
                terraform output
              workingDirectory: $(terraformWorkingDirectory)

























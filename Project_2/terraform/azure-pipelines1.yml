trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: azure_credential  # Includes SUBSCRIPTION_ID, CLIENT_ID, CLIENT_SECRET, TENANT_ID

stages:
  - stage: Terraform_Deploy
    displayName: 'Terraform Apply'
    jobs:
      - job: Terraform
        displayName: 'Run Terraform'
        timeoutInMinutes: 10
        steps:
          - checkout: self

          # Install Terraform
          - task: TerraformInstaller@0
            inputs:
              terraformVersion: 'latest'
            displayName: 'Install Terraform'

          # Azure Login using Service Connection
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'azure-sc'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az account show
            displayName: 'Azure Login'

          # Debug Azure DevOps Variables
          - script: |
              echo "Checking Azure DevOps Variables..."
              echo "SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)"
              echo "CLIENT_ID: $(CLIENT_ID)"
              echo "TENANT_ID: $(TENANT_ID)"
              echo "CLIENT_SECRET: [HIDDEN]"  # Hide secrets for security
            displayName: 'Debug Variables'

          # Set Terraform Authentication Environment Variables
          - script: |
              echo "Setting Terraform authentication variables..."
              export ARM_SUBSCRIPTION_ID=$(SUBSCRIPTION_ID)
              export ARM_CLIENT_ID=$(CLIENT_ID)
              export ARM_CLIENT_SECRET=$(CLIENT_SECRET)
              export ARM_TENANT_ID=$(TENANT_ID)

              export TF_VAR_SUBSCRIPTION_ID=$(SUBSCRIPTION_ID)
              export TF_VAR_CLIENT_ID=$(CLIENT_ID)
              export TF_VAR_CLIENT_SECRET=$(CLIENT_SECRET)
              export TF_VAR_TENANT_ID=$(TENANT_ID)

              echo "Terraform environment variables set successfully."
            displayName: 'Set Terraform Environment Variables'
            workingDirectory: $(Build.SourcesDirectory)/Project_2/terraform/

          # Initialize Terraform
          - script: terraform init
            displayName: 'Terraform Init'
            workingDirectory: $(Build.SourcesDirectory)/Project_2/terraform/

          # Validate Terraform configuration
          - script: terraform validate
            displayName: 'Terraform Validate'
            workingDirectory: $(Build.SourcesDirectory)/Project_2/terraform/

          # Check if RG1 already exists before importing
          - script: |
              RG_EXISTS=$(az group exists --name RG1)
              if [ "$RG_EXISTS" == "true" ]; then
                echo "Resource Group RG1 exists. Importing into Terraform..."
                terraform import azurerm_resource_group.rg /subscriptions/$(SUBSCRIPTION_ID)/resourceGroups/RG1 || echo "Import failed, continuing..."
              else
                echo "Resource Group RG1 does not exist. Skipping import."
              fi
            displayName: 'Terraform Import RG1'
            workingDirectory: $(Build.SourcesDirectory)/Project_2/terraform/

          # Run Terraform Plan with explicit variables
          - script: |
              terraform plan -out=tfplan \
                -var="SUBSCRIPTION_ID=$(SUBSCRIPTION_ID)" \
                -var="CLIENT_ID=$(CLIENT_ID)" \
                -var="CLIENT_SECRET=$(CLIENT_SECRET)" \
                -var="TENANT_ID=$(TENANT_ID)"
            displayName: 'Terraform Plan'
            workingDirectory: $(Build.SourcesDirectory)/Project_2/terraform/

          # Apply Terraform changes
          - script: |
              terraform apply -auto-approve tfplan
            displayName: 'Terraform Apply'
            condition: always()  # Ensures this step runs even if the previous one fails
            workingDirectory: $(Build.SourcesDirectory)/Project_2/terraform/


























